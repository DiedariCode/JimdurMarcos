<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Inventario - Jimdur Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <style>
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        .required {
            color: #dc3545;
        }
        
        .border-4 {
            border-width: 4px !important;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #007bff;
        }
        
        .capacity-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
        }
        
        .provider-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
        
        .stock-info {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid #22c55e;
        }
        
        .calculation-card {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-left: 4px solid #a855f7;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .capacity-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #e9ecef;
        }
        
        .capacity-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .btn-group-toggle .btn {
            border-radius: 20px;
            margin: 0 5px;
        }
        
        .provider-item {
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .provider-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .alert {
            border-radius: 10px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3 0%, #003d7a 100%);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar :: sidebar}"></div>

            <!-- Content -->
            <main class="col-md-9 col-lg-10 py-4 px-5 ms-auto">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-plus-circle text-primary me-2"></i>
                        Nuevo Inventario
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a th:href="@{/admin/inventario}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Volver al Inventario
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Formulario Principal -->
                <form id="formNuevoInventario" th:action="@{/admin/inventario/guardar}" method="post" class="needs-validation" novalidate>
                    <div class="row">
                        <!-- Columna Izquierda -->
                        <div class="col-lg-8">
                            <!-- Selección de Producto -->
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-box me-2"></i>
                                        Selección de Producto
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="productoSelect" class="form-label">
                                                📦 Producto <span class="required">*</span>
                                            </label>
                                            <select class="form-select form-select-lg" id="productoSelect" name="idProducto" required>
                                                <option value="">Selecciona el producto a almacenar...</option>
                                                <option th:each="producto : ${productos}" 
                                                        th:value="${producto.idProducto}" 
                                                        th:text="${producto.sku + ' - ' + producto.nombre}"
                                                        th:data-precio="${producto.precio}">
                                                </option>
                                            </select>
                                            <div class="form-text">Busca por SKU o nombre del producto</div>
                                            <div class="invalid-feedback">
                                                Por favor selecciona un producto válido.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Información del Producto (oculta inicialmente) -->
                                    <div id="infoProductoCard" class="mt-3" style="display: none;">
                                        <div class="alert info-card fade-in">
                                            <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Información del Producto</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Nombre:</strong> <span id="nombreProductoInfo"></span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>SKU:</strong> <span id="skuProductoInfo"></span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Precio Venta:</strong> S/ <span id="precioVentaInfo">0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selección de Ubicación -->
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        Selección de Ubicación
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="ubicacionSelect" class="form-label">
                                                📍 Ubicación <span class="required">*</span>
                                            </label>
                                            <select class="form-select form-select-lg" id="ubicacionSelect" name="idUbicacion" required>
                                                <option value="">Selecciona dónde almacenar...</option>
                                            </select>
                                            <div class="form-text">Selecciona la ubicación física en el almacén</div>
                                            <div class="invalid-feedback">
                                                Por favor selecciona una ubicación válida.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Información de Capacidad (oculta inicialmente) -->
                                    <div id="capacidadInfo" class="mt-3" style="display: none;">
                                        <div class="alert capacity-info fade-in">
                                            <h6 class="mb-3"><i class="fas fa-warehouse me-2"></i>Información de Capacidad</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <strong>Capacidad Total:</strong> <span id="capacidadTotal">0</span> unidades
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Ocupación Actual:</strong> <span id="ocupacionActual">0</span> unidades
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Espacio Disponible:</strong> <span id="espacioDisponible">0</span> unidades
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <label class="form-label">Nivel de Ocupación</label>
                                                <div class="capacity-bar">
                                                    <div id="capacityFill" class="capacity-fill bg-success" style="width: 0%"></div>
                                                </div>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small class="text-muted">Vacío</small>
                                                    <small id="porcentajeOcupacion" class="text-muted">0%</small>
                                                    <small class="text-muted">Lleno</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                                        <!-- Alerta de Inventario Existente -->
                    <div id="alertaInventarioExistente" class="alert alert-info border-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">⚠️ Inventario Existente Detectado</h6>
                                <p class="mb-1">Este producto ya tiene <strong id="cantidadExistente">0</strong> unidades en la ubicación <strong id="ubicacionExistente">-</strong></p>
                                <small class="text-muted">Valor actual: S/ <span id="valorExistente">0.00</span> por unidad</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerta de Capacidad -->
                    <div id="alertaCapacidad" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> <span id="mensajeCapacidad"></span>
                    </div>
                                </div>
                            </div>

                            <!-- Detalles del Inventario -->
                            <div class="card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-clipboard-list me-2"></i>
                                        Detalles del Inventario
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="cantidadInput" class="form-label">
                                                📊 Cantidad <span class="required">*</span>
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text"><i class="fas fa-boxes"></i></span>
                                                <input type="number" class="form-control" id="cantidadInput" name="cantidad" 
                                                       min="1" step="1" required placeholder="Ej: 50">
                                                <span class="input-group-text">unidades</span>
                                            </div>
                                            <div class="form-text">Cantidad de unidades a ingresar</div>
                                            <div class="invalid-feedback">
                                                Por favor ingresa una cantidad válida.
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="valorUnitarioInput" class="form-label">
                                                💰 Valor Unitario <span class="required">*</span>
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text">S/</span>
                                                <input type="number" class="form-control" id="valorUnitarioInput" name="valorUnitario" 
                                                       min="0.01" step="0.01" required placeholder="0.00">
                                            </div>
                                            <div class="form-text">Precio real que pagaste por unidad</div>
                                            <div class="invalid-feedback">
                                                Por favor ingresa un valor válido.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <label for="descripcionInput" class="form-label">
                                                📝 Descripción <span class="text-muted">(opcional)</span>
                                            </label>
                                            <textarea class="form-control" id="descripcionInput" name="descripcion" rows="3" 
                                                      placeholder="Información adicional sobre este lote de inventario..."></textarea>
                                            <div class="form-text">Detalles sobre el lote, proveedor, fecha de compra, etc.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha -->
                        <div class="col-lg-4">
                            <!-- Información de Proveedores -->
                            <div id="proveedoresCard" class="card mb-4" style="display: none;">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-truck me-2"></i>
                                        Proveedores Sugeridos
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="listaProveedores">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- Cálculos en Tiempo Real -->
                            <div class="card mb-4">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-calculator me-2"></i>
                                        Cálculos Automáticos
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert calculation-card">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <h6 class="text-primary">💰 Inversión Total</h6>
                                                <h3 class="mb-0">S/ <span id="valorTotalCalculado">0.00</span></h3>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <h6 class="text-success">📈 Ganancia Estimada</h6>
                                                <h4 class="mb-0 text-success">S/ <span id="gananciaEstimada">0.00</span></h4>
                                                <small class="text-muted">Por unidad: S/ <span id="gananciaPorUnidad">0.00</span></small>
                                            </div>
                                            <div class="col-12">
                                                <h6 class="text-info">📊 Margen de Ganancia</h6>
                                                <div class="progress mb-2">
                                                    <div id="progressMargen" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted"><span id="porcentajeMargen">0</span>% de margen</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-cog me-2"></i>
                                        Acciones
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <button type="button" class="btn btn-secondary btn-lg w-100 mb-3" onclick="limpiarFormulario()">
                                        <i class="fas fa-eraser me-2"></i>
                                        Limpiar Formulario
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-lg w-100" id="btnGuardar">
                                        <i class="fas fa-save me-2"></i>
                                        Crear Inventario
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <script>
        // Variables globales
        let ubicacionesConOcupacion = [];
        let productoSeleccionado = null;
        let ubicacionSeleccionada = null;
        let stockActualProducto = []; // Para detectar inventario existente
        
        // CSRF Token para AJAX
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
        const token = csrfToken ? csrfToken.getAttribute('content') : '';
        const header = csrfHeader ? csrfHeader.getAttribute('content') : 'X-CSRF-TOKEN';

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            cargarUbicaciones();
            configurarEventListeners();
            
            // Mensajes de éxito/error
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                Swal.fire({
                    title: '¡Éxito!',
                    text: 'Inventario creado correctamente',
                    icon: 'success',
                    timer: 3000
                });
            }
            if (urlParams.get('error') === 'true') {
                Swal.fire({
                    title: 'Error',
                    text: 'Error al crear el inventario',
                    icon: 'error'
                });
            }
        });

        // Configurar Event Listeners
        function configurarEventListeners() {
            // Selección de producto
            document.getElementById('productoSelect').addEventListener('change', function() {
                const productoId = this.value;
                if (productoId) {
                    cargarInformacionProducto(productoId);
                } else {
                    ocultarInformacionProducto();
                }
            });

            // Selección de ubicación
            document.getElementById('ubicacionSelect').addEventListener('change', function() {
                const ubicacionId = this.value;
                if (ubicacionId) {
                    mostrarInformacionUbicacion(ubicacionId);
                } else {
                    ocultarInformacionUbicacion();
                }
            });

            // Cálculos automáticos
            document.getElementById('cantidadInput').addEventListener('input', function() {
                validarCapacidad();
                calcularTotales();
            });

            document.getElementById('valorUnitarioInput').addEventListener('input', function() {
                calcularTotales();
            });

            // Formulario submit
            document.getElementById('formNuevoInventario').addEventListener('submit', function(e) {
                e.preventDefault();
                confirmarCreacion();
            });
        }

        // Cargar ubicaciones con información de ocupación
        function cargarUbicaciones() {
            fetch('/admin/ubicacion/api')
                .then(response => response.json())
                .then(ubicaciones => {
                    ubicacionesConOcupacion = ubicaciones;
                    const select = document.getElementById('ubicacionSelect');
                    select.innerHTML = '<option value="">Selecciona dónde almacenar...</option>';
                    
                    ubicaciones.forEach(ubicacion => {
                        const option = document.createElement('option');
                        option.value = ubicacion.idUbicacion;
                        option.textContent = `${ubicacion.codigo} - ${ubicacion.nombre} (${ubicacion.espacioDisponible}/${ubicacion.capacidad})`;
                        option.dataset.ubicacion = JSON.stringify(ubicacion);
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar ubicaciones:', error);
                    Swal.fire('Error', 'No se pudieron cargar las ubicaciones', 'error');
                });
        }

        // Cargar información del producto
        function cargarInformacionProducto(productoId) {
            const select = document.getElementById('productoSelect');
            const option = select.selectedOptions[0];
            
            if (option) {
                const texto = option.textContent;
                const partes = texto.split(' - ');
                const sku = partes[0];
                const nombre = partes[1];
                const precio = parseFloat(option.dataset.precio) || 0;
                
                productoSeleccionado = {
                    id: productoId,
                    sku: sku,
                    nombre: nombre,
                    precio: precio
                };
                
                // Mostrar información del producto
                document.getElementById('nombreProductoInfo').textContent = nombre;
                document.getElementById('skuProductoInfo').textContent = sku;
                document.getElementById('precioVentaInfo').textContent = precio.toFixed(2);
                document.getElementById('infoProductoCard').style.display = 'block';
                
                // Cargar proveedores
                cargarProveedores(productoId);
                
                // Cargar stock actual para detección de inventario existente
                cargarStockActual(productoId);
                
                // Recalcular totales
                calcularTotales();
            }
        }

        // Función para cargar stock actual del producto
        function cargarStockActual(productoId) {
            if (!productoId) {
                stockActualProducto = [];
                return;
            }
            
            fetch(`/admin/inventario/producto/${productoId}`)
                .then(response => response.json())
                .then(inventarios => {
                    stockActualProducto = inventarios; // Guardar para detectar inventario existente
                    console.log('Stock actual cargado:', stockActualProducto);
                })
                .catch(error => {
                    console.error('Error al cargar stock actual:', error);
                    stockActualProducto = [];
                });
        }

        // Ocultar información del producto
        function ocultarInformacionProducto() {
            document.getElementById('infoProductoCard').style.display = 'none';
            document.getElementById('proveedoresCard').style.display = 'none';
            productoSeleccionado = null;
            calcularTotales();
        }

        // Cargar proveedores del producto
        function cargarProveedores(productoId) {
            fetch(`/api/productos/${productoId}/proveedores`)
                .then(response => response.json())
                .then(proveedores => {
                    if (proveedores.length === 0 && productoSeleccionado) {
                        // Proveedores de ejemplo si no hay datos reales
                        proveedores = [
                            { nombre: 'Proveedor Sugerido A', precio: (productoSeleccionado.precio * 0.7).toFixed(2) },
                            { nombre: 'Proveedor Sugerido B', precio: (productoSeleccionado.precio * 0.65).toFixed(2) },
                            { nombre: 'Proveedor Sugerido C', precio: (productoSeleccionado.precio * 0.75).toFixed(2) }
                        ];
                    }
                    
                    mostrarProveedores(proveedores);
                })
                .catch(error => {
                    console.error('Error al cargar proveedores:', error);
                    if (productoSeleccionado) {
                        // Mostrar proveedores de ejemplo en caso de error
                        const proveedoresEjemplo = [
                            { nombre: 'Proveedor Sugerido A', precio: (productoSeleccionado.precio * 0.7).toFixed(2) },
                            { nombre: 'Proveedor Sugerido B', precio: (productoSeleccionado.precio * 0.65).toFixed(2) }
                        ];
                        mostrarProveedores(proveedoresEjemplo);
                    }
                });
        }

        // Mostrar proveedores
        function mostrarProveedores(proveedores) {
            const container = document.getElementById('listaProveedores');
            container.innerHTML = '';
            
            proveedores.forEach(proveedor => {
                const div = document.createElement('div');
                div.className = 'provider-item alert provider-card p-3 mb-2';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${proveedor.nombre}</h6>
                            <small class="text-muted">Precio sugerido</small>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0 text-primary">S/ ${proveedor.precio}</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="usarPrecioProveedor(${proveedor.precio})">
                                <i class="fas fa-arrow-down me-1"></i>Usar
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('proveedoresCard').style.display = 'block';
        }

        // Usar precio de proveedor
        function usarPrecioProveedor(precio) {
            document.getElementById('valorUnitarioInput').value = precio;
            calcularTotales();
            
            // Animación visual
            const input = document.getElementById('valorUnitarioInput');
            input.classList.add('border-success');
            setTimeout(() => {
                input.classList.remove('border-success');
            }, 1000);
        }

        // Mostrar información de ubicación
        function mostrarInformacionUbicacion(ubicacionId) {
            const ubicacion = ubicacionesConOcupacion.find(u => u.idUbicacion == ubicacionId);
            if (ubicacion) {
                ubicacionSeleccionada = ubicacion;
                
                // Actualizar información
                document.getElementById('capacidadTotal').textContent = ubicacion.capacidad;
                document.getElementById('ocupacionActual').textContent = ubicacion.ocupacionActual;
                document.getElementById('espacioDisponible').textContent = ubicacion.espacioDisponible;
                document.getElementById('porcentajeOcupacion').textContent = ubicacion.porcentajeOcupacion.toFixed(1) + '%';
                
                // Actualizar barra de progreso
                const porcentaje = ubicacion.porcentajeOcupacion;
                const fill = document.getElementById('capacityFill');
                fill.style.width = porcentaje + '%';
                
                // Cambiar color según ocupación
                fill.className = 'capacity-fill';
                if (porcentaje <= 25) {
                    fill.classList.add('bg-success');
                } else if (porcentaje <= 75) {
                    fill.classList.add('bg-warning');
                } else if (porcentaje <= 100) {
                    fill.classList.add('bg-danger');
                } else {
                    fill.classList.add('bg-dark');
                }
                
                document.getElementById('capacidadInfo').style.display = 'block';
                
                // Detectar inventario existente en esta ubicación
                detectarInventarioExistente(ubicacionId);
                
                // Validar capacidad
                validarCapacidad();
            }
        }

        // Detectar si ya existe inventario en la ubicación seleccionada
        function detectarInventarioExistente(ubicacionId) {
            // Buscar si hay stock del producto actual en la ubicación seleccionada
            const stockExistente = stockActualProducto.find(inv => inv.idUbicacion == ubicacionId);
            
            if (stockExistente && productoSeleccionado) {
                // Mostrar alerta de inventario existente
                const alertaExistente = document.getElementById('alertaInventarioExistente');
                if (alertaExistente) {
                    document.getElementById('cantidadExistente').textContent = stockExistente.cantidad;
                    document.getElementById('valorExistente').textContent = stockExistente.valorUnitario.toFixed(2);
                    document.getElementById('ubicacionExistente').textContent = ubicacionSeleccionada.nombre;
                    alertaExistente.style.display = 'block';
                    
                    // Cambiar texto del botón y placeholder
                    const btnGuardar = document.getElementById('btnGuardar');
                    btnGuardar.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar Inventario Existente';
                    btnGuardar.className = 'btn btn-warning btn-lg';
                    
                    document.getElementById('cantidadInput').placeholder = 'Nueva cantidad total';
                    document.getElementById('valorUnitarioInput').placeholder = 'Nuevo valor unitario';
                    
                    // Prellenar valores actuales
                    document.getElementById('cantidadInput').value = stockExistente.cantidad;
                    document.getElementById('valorUnitarioInput').value = stockExistente.valorUnitario;
                    
                    // Recalcular totales
                    calcularTotales();
                } else {
                    // Si no existe el elemento de alerta, crear uno dinámicamente
                    crearAlertaInventarioExistente(stockExistente);
                }
            } else {
                // No hay inventario existente, mostrar como nuevo
                const alertaExistente = document.getElementById('alertaInventarioExistente');
                if (alertaExistente) {
                    alertaExistente.style.display = 'none';
                }
                
                // Restaurar botón y placeholders originales
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Crear Nuevo Inventario';
                btnGuardar.className = 'btn btn-primary btn-lg';
                
                document.getElementById('cantidadInput').placeholder = 'Cantidad a ingresar';
                document.getElementById('valorUnitarioInput').placeholder = 'Valor unitario';
                
                // Limpiar valores
                document.getElementById('cantidadInput').value = '';
                document.getElementById('valorUnitarioInput').value = '';
                
                // Recalcular totales
                calcularTotales();
            }
        }

        // Crear alerta de inventario existente dinámicamente
        function crearAlertaInventarioExistente(stockExistente) {
            const alertaHtml = `
                <div id="alertaInventarioExistente" class="alert alert-info border-info" style="display: block;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-2x text-info me-3"></i>
                        <div>
                            <h6 class="mb-1">⚠️ Inventario Existente Detectado</h6>
                            <p class="mb-1">Este producto ya tiene <strong id="cantidadExistente">${stockExistente.cantidad}</strong> unidades en la ubicación <strong id="ubicacionExistente">${ubicacionSeleccionada.nombre}</strong></p>
                            <small class="text-muted">Valor actual: S/ <span id="valorExistente">${stockExistente.valorUnitario.toFixed(2)}</span> por unidad</small>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar antes del formulario
            const formContainer = document.querySelector('#capacidadInfo');
            formContainer.insertAdjacentHTML('afterend', alertaHtml);
        }

        // Ocultar información de ubicación
        function ocultarInformacionUbicacion() {
            document.getElementById('capacidadInfo').style.display = 'none';
            document.getElementById('alertaCapacidad').style.display = 'none';
            ubicacionSeleccionada = null;
        }

        // Validar capacidad
        function validarCapacidad() {
            const cantidad = parseInt(document.getElementById('cantidadInput').value) || 0;
            const alerta = document.getElementById('alertaCapacidad');
            const mensaje = document.getElementById('mensajeCapacidad');
            const btnGuardar = document.getElementById('btnGuardar');
            
            if (ubicacionSeleccionada && cantidad > 0) {
                if (cantidad > ubicacionSeleccionada.espacioDisponible) {
                    mensaje.textContent = `La cantidad ingresada (${cantidad}) supera el espacio disponible (${ubicacionSeleccionada.espacioDisponible}) en esta ubicación.`;
                    alerta.className = 'alert alert-danger';
                    alerta.style.display = 'block';
                    btnGuardar.disabled = true;
                } else if (cantidad > ubicacionSeleccionada.espacioDisponible * 0.8) {
                    mensaje.textContent = `La cantidad ingresada ocupará más del 80% del espacio disponible en esta ubicación.`;
                    alerta.className = 'alert alert-warning';
                    alerta.style.display = 'block';
                    btnGuardar.disabled = false;
                } else {
                    alerta.style.display = 'none';
                    btnGuardar.disabled = false;
                }
            } else {
                alerta.style.display = 'none';
                btnGuardar.disabled = false;
            }
        }

        // Calcular totales
        function calcularTotales() {
            const cantidad = parseInt(document.getElementById('cantidadInput').value) || 0;
            const valorUnitario = parseFloat(document.getElementById('valorUnitarioInput').value) || 0;
            const precioVenta = productoSeleccionado ? productoSeleccionado.precio : 0;
            
            // Valor total de la inversión
            const valorTotal = cantidad * valorUnitario;
            document.getElementById('valorTotalCalculado').textContent = valorTotal.toFixed(2);
            
            // Ganancia estimada
            const gananciaPorUnidad = Math.max(0, precioVenta - valorUnitario);
            const gananciaTotal = cantidad * gananciaPorUnidad;
            document.getElementById('gananciaPorUnidad').textContent = gananciaPorUnidad.toFixed(2);
            document.getElementById('gananciaEstimada').textContent = gananciaTotal.toFixed(2);
            
            // Margen de ganancia
            const margenPorcentaje = valorUnitario > 0 ? (gananciaPorUnidad / valorUnitario) * 100 : 0;
            document.getElementById('porcentajeMargen').textContent = margenPorcentaje.toFixed(1);
            document.getElementById('progressMargen').style.width = Math.min(margenPorcentaje, 100) + '%';
            
            // Cambiar color del margen según porcentaje
            const progressBar = document.getElementById('progressMargen');
            progressBar.className = 'progress-bar';
            if (margenPorcentaje >= 50) {
                progressBar.classList.add('bg-success');
            } else if (margenPorcentaje >= 25) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-danger');
            }
        }

        // Limpiar formulario
        function limpiarFormulario() {
            Swal.fire({
                title: '¿Limpiar formulario?',
                text: 'Se perderán todos los datos ingresados',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, limpiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('formNuevoInventario').reset();
                    ocultarInformacionProducto();
                    ocultarInformacionUbicacion();
                    calcularTotales();
                }
            });
        }

        // Confirmar creación
        function confirmarCreacion() {
            if (!document.getElementById('formNuevoInventario').checkValidity()) {
                document.getElementById('formNuevoInventario').reportValidity();
                return;
            }
            
            const cantidad = parseInt(document.getElementById('cantidadInput').value);
            const valorUnitario = parseFloat(document.getElementById('valorUnitarioInput').value);
            const valorTotal = cantidad * valorUnitario;
            
            Swal.fire({
                title: '¿Confirmar creación?',
                html: `
                    <div class="text-start">
                        <p><strong>Producto:</strong> ${productoSeleccionado ? productoSeleccionado.nombre : 'N/A'}</p>
                        <p><strong>Ubicación:</strong> ${ubicacionSeleccionada ? ubicacionSeleccionada.nombre : 'N/A'}</p>
                        <p><strong>Cantidad:</strong> ${cantidad} unidades</p>
                        <p><strong>Valor Unitario:</strong> S/ ${valorUnitario.toFixed(2)}</p>
                        <p><strong>Inversión Total:</strong> S/ ${valorTotal.toFixed(2)}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, crear inventario',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('formNuevoInventario').submit();
                }
            });
        }

        // Validación de Bootstrap
        (() => {
            'use strict';
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();
    </script>
</body>
</html> 