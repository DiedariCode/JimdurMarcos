<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JIMDUR Admin - Gesti√≥n de Productos</title>
    <!-- ICONOS BOOTSTRAP -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- CSS de Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ICONOS FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- CSS PERSONALIZADO -->
    <link rel="stylesheet" th:href="@{/css/admin/productos.css}">
    <link rel="stylesheet" th:href="@{/css/shared/sidebar.css}">
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    
    <style>
        .cursor-pointer {
            cursor: pointer;
        }
        .cursor-pointer:hover {
            text-decoration: underline;
        }
        .border-4 {
            border-width: 4px !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar :: sidebar}"></div>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 ms-auto px-4 py-4 content-wrapper animate-fade">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center page-header">
                    <div>
                        <h2>Gesti√≥n de Productos</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 mt-1">
                                <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Productos</li>
                            </ol>
                        </nav>
                    </div>
                    <a th:href="@{/admin/productos/nuevo}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Agregar Producto
                    </a>
                </div>

                <!-- Alertas -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Tabla de Productos -->
                <div class="card mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle m-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 80px">Imagen</th>
                                        <th>Informaci√≥n</th>
                                        <th>Categor√≠a</th>
                                        <th>Marca</th>
                                        <th>Precios</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="producto : ${productos}">
                                        <!-- Imagen -->
                                        <td>
                                            <div class="product-img-wrapper">
                                                <img th:if="${producto.rutaImagenPortada != null}"
                                                     th:src="@{'/uploads/productos/' + ${producto.rutaImagenPortada}}"
                                                     class="product-img" alt="Imagen producto">
                                                <div th:if="${producto.rutaImagenPortada == null}" class="product-img-placeholder">
                                                    <i class="fas fa-box fa-2x"></i>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <!-- Informaci√≥n -->
                                        <td>
                                            <div class="d-flex flex-column">
                                                <div class="fw-medium mb-1" th:text="${producto.nombre}">Nombre del
                                                    producto</div>
                                                <div class="text-muted small mb-1" th:text="${producto.sku}">SKU-001
                                                </div>
                                                <small class="text-muted"
                                                    th:text="${#strings.abbreviate(producto.descripcion, 50)}">Descripci√≥n
                                                    corta...</small>
                                            </div>
                                        </td>

                                        <!-- Categor√≠a -->
                                        <td>
                                            <span class="badge text-bg-info"
                                                th:text="${producto.nombreCategoria}">Categor√≠a</span>
                                        </td>

                                        <!-- Marca -->
                                        <td>
                                            <span class="badge text-bg-secondary"
                                                th:text="${producto.nombreMarca}">Marca</span>
                                        </td>

                                        <!-- Precios -->
                                        <td>
                                            <div class="d-flex flex-column">
                                                <div class="mb-1">
                                                    <span class="text-muted small">Precio:</span>
                                                    <span class="fw-medium"
                                                        th:text="'S/ ' + ${#numbers.formatDecimal(producto.precio, 1, 2)}">S/
                                                        0.00</span>
                                                </div>
                                                <div th:if="${producto.descuento > 0}" class="mb-1">
                                                    <span class="text-danger small">Descuento:</span>
                                                    <span class="text-danger"
                                                        th:text="${producto.descuento + '%'}">0%</span>
                                                </div>
                                                <div th:if="${producto.precioOferta != null}">
                                                    <span class="text-success small">Precio final:</span>
                                                    <span class="fw-medium text-success"
                                                        th:text="'S/ ' + ${#numbers.formatDecimal(producto.precioOferta, 1, 2)}">S/
                                                        0.00</span>
                                                </div>
                                            </div>
                                        </td>

                                        <!-- Estado -->
                                        <td>
                                            <span class="badge"
                                                th:classappend="${producto.activo ? 'text-bg-success' : 'text-bg-secondary'}"
                                                th:text="${producto.activo ? 'Activo' : 'Inactivo'}">Estado</span>
                                        </td>

                                        <!-- Acciones -->
                                        <td>
                                            <div class="d-flex justify-content-center gap-1 flex-wrap">
                                                <a th:href="@{/admin/productos/{id}/detalle(id=${producto.idProducto})}"
                                                    class="btn btn-sm btn-info" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a th:href="@{/admin/productos/{id}/editar(id=${producto.idProducto})}"
                                                    class="btn btn-sm btn-warning" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-sm btn-success"
                                                        title="Gestionar Stock"
                                                        onclick="abrirModalStock(this)"
                                                        th:data-producto-id="${producto.idProducto}"
                                                        th:data-producto-nombre="${producto.nombre}"
                                                        th:data-producto-sku="${producto.sku}">
                                                    <i class="fas fa-boxes"></i>
                                                </button>
                                                <form
                                                    th:action="@{/admin/productos/{id}/eliminar(id=${producto.idProducto})}"
                                                    method="post" class="d-inline"
                                                    onsubmit="return confirm('¬øEst√°s seguro de eliminar este producto?');">

                                                    <!-- Token CSRF para seguridad -->
                                                    <input type="hidden" th:name="${_csrf.parameterName}"
                                                        th:value="${_csrf.token}" />

                                                    <button type="submit" class="btn btn-sm btn-danger"
                                                        title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>

                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(productos)}">
                                        <td colspan="7" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-box-open fa-3x mb-3"></i>
                                                <p class="mb-0">No se encontraron productos</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center p-3" th:if="${totalPages > 0}">
                            <div class="text-muted">
                                Mostrando <span th:text="${productos.numberOfElements}">5</span> de 
                                <span th:text="${totalItems}">20</span> productos
                            </div>
                            <nav>
                                <ul class="pagination mb-0">
                                    <!-- Primera p√°gina -->
                                    <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/admin/productos(page=0, size=${pageSize}, sortField=${sortField}, sortDirection=${sortDirection}, nombreProducto=${nombreProducto})}">&laquo;</a>
                                    </li>
                                    
                                    <!-- P√°gina anterior -->
                                    <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/admin/productos(page=${currentPage - 1}, size=${pageSize}, sortField=${sortField}, sortDirection=${sortDirection}, nombreProducto=${nombreProducto})}">&lt;</a>
                                    </li>

                                    <!-- P√°ginas -->
                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" 
                                        th:classappend="${currentPage == i ? 'active' : ''}"
                                        th:if="${i >= currentPage - 2 and i <= currentPage + 2}">
                                        <a class="page-link" th:href="@{/admin/productos(page=${i}, size=${pageSize}, sortField=${sortField}, sortDirection=${sortDirection}, nombreProducto=${nombreProducto})}" 
                                           th:text="${i + 1}">1</a>
                                    </li>

                                    <!-- P√°gina siguiente -->
                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/admin/productos(page=${currentPage + 1}, size=${pageSize}, sortField=${sortField}, sortDirection=${sortDirection}, nombreProducto=${nombreProducto})}">&gt;</a>
                                    </li>
                                    
                                    <!-- √öltima p√°gina -->
                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/admin/productos(page=${totalPages - 1}, size=${pageSize}, sortField=${sortField}, sortDirection=${sortDirection}, nombreProducto=${nombreProducto})}">&raquo;</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Asignar Stock -->
    <div class="modal fade" id="modalAsignarStock" tabindex="-1" aria-labelledby="modalAsignarStockLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAsignarStockLabel">
                        <i class="fas fa-boxes me-2"></i>Gestionar Stock del Producto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n del producto -->
                    <div class="alert alert-info mb-3">
                        <h6 class="mb-1"><i class="fas fa-box me-2"></i><span id="nombreProductoModal"></span></h6>
                        <small class="text-muted">SKU: <span id="skuProductoModal"></span></small>
                    </div>

                    <!-- Pesta√±as -->
                    <ul class="nav nav-tabs" id="stockTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="asignar-tab" data-bs-toggle="tab" data-bs-target="#asignar" type="button" role="tab">
                                <i class="fas fa-plus me-1"></i>Asignar Stock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="actual-tab" data-bs-toggle="tab" data-bs-target="#actual" type="button" role="tab">
                                <i class="fas fa-list me-1"></i>Stock Actual
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="movimientos-tab" data-bs-toggle="tab" data-bs-target="#movimientos" type="button" role="tab">
                                <i class="fas fa-history me-1"></i>√öltimos Movimientos
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="stockTabContent">
                        <!-- Tab Asignar Stock -->
                        <div class="tab-pane fade show active" id="asignar" role="tabpanel">
                            <!-- Informaci√≥n sobre precios -->
                            <div class="alert alert-light border-start border-4 border-primary mb-3">
                                <h6 class="fw-bold text-primary mb-2">üí° Informaci√≥n sobre Precios</h6>
                                <small class="text-muted">
                                    <strong>Valor Unitario:</strong> Es el precio que pagaste al comprar este lote espec√≠fico (puede incluir descuentos, promociones, etc.)<br>
                                    <strong>Precio de Venta:</strong> S/ <span id="precioVentaProducto">0.00</span> (definido en el producto)
                                </small>
                            </div>

                            <!-- Referencia de proveedores -->
                            <div class="card bg-light mb-3" id="cardProveedores" style="display: none;">
                                <div class="card-header">
                                    <small class="fw-bold">üìã Precios de Referencia por Proveedor</small>
                                </div>
                                <div class="card-body py-2">
                                    <div id="listaProveedores" class="row"></div>
                                </div>
                            </div>

                            <!-- Stock existente en ubicaci√≥n seleccionada -->
                            <div class="alert alert-info mb-3" id="stockExistenteInfo" style="display: none;">
                                <h6 class="mb-2">üìã Stock Actual en esta Ubicaci√≥n</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small><strong>Cantidad Actual:</strong> <span id="stockActualCantidad">0</span> unidades</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small><strong>Valor Unitario:</strong> S/ <span id="stockActualValor">0.00</span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <small><strong>Valor Total:</strong> S/ <span id="stockActualTotal">0.00</span></small>
                                    </div>
                                </div>
                            </div>

                            <form id="formAsignarStock">
                                <!-- Selector de operaci√≥n (mostrar solo si hay stock existente) -->
                                <div class="mb-3" id="tipoOperacionGroup" style="display: none;">
                                    <label class="form-label">üîÑ Tipo de Operaci√≥n</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="tipoOperacion" id="operacionAgregar" value="ENTRADA" checked>
                                        <label class="btn btn-outline-success" for="operacionAgregar">‚ûï Agregar Stock</label>
                                        
                                        <input type="radio" class="btn-check" name="tipoOperacion" id="operacionReducir" value="SALIDA">
                                        <label class="btn btn-outline-danger" for="operacionReducir">‚ûñ Reducir Stock</label>
                                        
                                        <input type="radio" class="btn-check" name="tipoOperacion" id="operacionAjustar" value="AJUSTE">
                                        <label class="btn btn-outline-warning" for="operacionAjustar">üîß Ajustar Stock</label>
                                    </div>
                                    <small class="text-muted">Selecciona qu√© tipo de movimiento deseas realizar</small>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="ubicacionSelect" class="form-label">
                                                üìç Ubicaci√≥n <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="ubicacionSelect" required>
                                                <option value="">Seleccionar ubicaci√≥n de almac√©n...</option>
                                            </select>
                                            <small class="text-muted">Lugar f√≠sico donde se almacenar√° el producto</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="cantidadInput" class="form-label">
                                                üì¶ <span id="labelCantidad">Cantidad</span> <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control" id="cantidadInput" min="1" required>
                                            <small class="text-muted" id="helpCantidad">Unidades a ingresar</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="valorUnitarioInput" class="form-label">
                                                üí∞ Valor Unitario <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">S/.</span>
                                                <input type="number" class="form-control" id="valorUnitarioInput" step="0.01" min="0.01" required>
                                            </div>
                                            <small class="text-muted">Precio real que pagaste por unidad</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock resultante (mostrar solo si hay stock existente) -->
                                <div class="row mb-3" id="stockResultanteInfo" style="display: none;">
                                    <div class="col-12">
                                        <div class="alert alert-secondary">
                                            <h6 class="mb-2">üìä Stock Resultante</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <small><strong>Cantidad Final:</strong> <span id="stockFinalCantidad">0</span> unidades</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small><strong>Diferencia:</strong> <span id="diferenciaCantidad">0</span> unidades</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small><strong>Valor Total Final:</strong> S/ <span id="stockFinalTotal">0.00</span></small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informaci√≥n calculada -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="bg-light p-2 rounded">
                                            <small class="text-muted">üí∏ <strong>Costo Total:</strong> S/ <span id="costoTotal">0.00</span></small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="bg-light p-2 rounded">
                                            <small class="text-muted">üìà <strong>Ganancia por Unidad:</strong> S/ <span id="gananciaPorUnidad">0.00</span></small>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="descripcionInput" class="form-label">üìù Descripci√≥n</label>
                                    <textarea class="form-control" id="descripcionInput" rows="2" placeholder="Ej: Compra a Proveedor X con descuento del 10%"></textarea>
                                    <small class="text-muted">Informaci√≥n adicional sobre esta operaci√≥n (opcional)</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="btnSubmitStock">
                                    <i class="fas fa-save me-2"></i><span id="textoBotonSubmit">Asignar Stock al Inventario</span>
                                </button>
                            </form>
                        </div>

                        <!-- Tab Stock Actual -->
                        <div class="tab-pane fade" id="actual" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ubicaci√≥n</th>
                                            <th>C√≥digo</th>
                                            <th>Cantidad</th>
                                            <th>Valor Unit.</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaStockActual">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Movimientos -->
                        <div class="tab-pane fade" id="movimientos" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Cantidad</th>
                                            <th>Descripci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaMovimientos">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="btnVerInventarioCompleto" href="#" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt me-2"></i>Ver Inventario Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JavaScript para el modal de stock -->
    <script>
        let productoActualId = null;
        
        // CSRF Token para AJAX
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
        const token = csrfToken ? csrfToken.getAttribute('content') : '';
        const header = csrfHeader ? csrfHeader.getAttribute('content') : 'X-CSRF-TOKEN';

        function abrirModalStock(button) {
            // Obtener datos del bot√≥n
            const idProducto = button.getAttribute('data-producto-id');
            const nombreProducto = button.getAttribute('data-producto-nombre');
            const skuProducto = button.getAttribute('data-producto-sku');
            
            productoActualId = parseInt(idProducto);
            
            // Actualizar informaci√≥n del producto en el modal
            document.getElementById('nombreProductoModal').textContent = nombreProducto;
            document.getElementById('skuProductoModal').textContent = skuProducto;
            document.getElementById('btnVerInventarioCompleto').href = `/admin/inventario?busqueda=${encodeURIComponent(skuProducto)}&tipoBusqueda=sku`;
            
            // Cargar datos del producto
            cargarInformacionProducto(idProducto);
            
            // Cargar ubicaciones
            cargarUbicaciones();
            
            // Cargar stock actual para an√°lisis
            cargarStockActual();
            
            // Resetear formulario y ocultar opciones de stock
            document.getElementById('formAsignarStock').reset();
            ocultarOpcionesStock();
            actualizarCalculos();
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalAsignarStock'));
            modal.show();
        }

        function cargarInformacionProducto(idProducto) {
            // Obtener el precio del producto desde la tabla
            const filaProducto = document.querySelector(`button[data-producto-id="${idProducto}"]`).closest('tr');
            const precioTexto = filaProducto.querySelector('td:nth-child(5)').textContent;
            const precio = parseFloat(precioTexto.match(/S\/\s*([0-9,.]+)/)?.[1]?.replace(',', '') || '0');
            
            document.getElementById('precioVentaProducto').textContent = precio.toFixed(2);
            
            // Cargar proveedores reales del producto
            fetch(`/api/productos/${idProducto}/proveedores`)
                .then(response => response.json())
                .then(proveedores => {
                    // Si no hay proveedores reales, usar datos de ejemplo basados en el precio
                    if (proveedores.length === 0) {
                        const ejemploProveedores = [
                            { nombre: 'Proveedor Sugerido A', precio: (precio * 0.7).toFixed(2) },
                            { nombre: 'Proveedor Sugerido B', precio: (precio * 0.65).toFixed(2) },
                            { nombre: 'Proveedor Sugerido C', precio: (precio * 0.75).toFixed(2) }
                        ];
                        mostrarProveedores(ejemploProveedores, true);
                    } else {
                        mostrarProveedores(proveedores, false);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar proveedores:', error);
                    // En caso de error, mostrar datos de ejemplo
                    const ejemploProveedores = [
                        { nombre: 'Proveedor Estimado A', precio: (precio * 0.7).toFixed(2) },
                        { nombre: 'Proveedor Estimado B', precio: (precio * 0.65).toFixed(2) }
                    ];
                    mostrarProveedores(ejemploProveedores, true);
                });
        }

        function mostrarProveedores(proveedores, esEjemplo = false) {
            const listaProveedores = document.getElementById('listaProveedores');
            const cardProveedores = document.getElementById('cardProveedores');
            
            if (proveedores && proveedores.length > 0) {
                const titulo = esEjemplo ? 
                    'üí° Precios de Referencia Estimados (click para usar)' : 
                    'üìã Precios de Proveedores Registrados (click para usar)';
                
                cardProveedores.querySelector('.card-header small').innerHTML = titulo;
                
                listaProveedores.innerHTML = proveedores.map(proveedor => `
                    <div class="col-md-4 mb-2">
                        <small class="d-block">
                            <strong>${proveedor.nombre}:</strong> 
                            <span class="text-primary cursor-pointer fw-bold" onclick="aplicarPrecioProveedor(${proveedor.precio})" title="Click para usar este precio">
                                S/ ${proveedor.precio}
                            </span>
                            ${esEjemplo ? '<small class="text-muted d-block">(estimado)</small>' : '<small class="text-success d-block">(registrado)</small>'}
                        </small>
                    </div>
                `).join('');
                cardProveedores.style.display = 'block';
            } else {
                cardProveedores.style.display = 'none';
            }
        }

        function aplicarPrecioProveedor(precio) {
            document.getElementById('valorUnitarioInput').value = precio;
            actualizarCalculos();
        }

        function actualizarCalculos() {
            const cantidad = parseFloat(document.getElementById('cantidadInput').value) || 0;
            const valorUnitario = parseFloat(document.getElementById('valorUnitarioInput').value) || 0;
            const precioVenta = parseFloat(document.getElementById('precioVentaProducto').textContent) || 0;
            
            const costoTotal = cantidad * valorUnitario;
            const gananciaPorUnidad = precioVenta - valorUnitario;
            
            document.getElementById('costoTotal').textContent = costoTotal.toFixed(2);
            document.getElementById('gananciaPorUnidad').textContent = gananciaPorUnidad.toFixed(2);
            
            // Cambiar color seg√∫n la ganancia
            const elementoGanancia = document.getElementById('gananciaPorUnidad');
            if (gananciaPorUnidad > 0) {
                elementoGanancia.className = 'text-success fw-bold';
            } else if (gananciaPorUnidad < 0) {
                elementoGanancia.className = 'text-danger fw-bold';
            } else {
                elementoGanancia.className = 'text-warning fw-bold';
            }
        }

        function cargarUbicaciones() {
            fetch('/admin/ubicacion/api')
                .then(response => response.json())
                .then(ubicaciones => {
                    const select = document.getElementById('ubicacionSelect');
                    select.innerHTML = '<option value="">Seleccionar ubicaci√≥n...</option>';
                    
                    ubicaciones.forEach(ubicacion => {
                        const option = document.createElement('option');
                        option.value = ubicacion.idUbicacion;
                        option.textContent = `${ubicacion.nombre} (${ubicacion.codigo}) - Capacidad: ${ubicacion.capacidad}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar ubicaciones:', error);
                    Swal.fire('Error', 'No se pudieron cargar las ubicaciones', 'error');
                });
        }

        // Variable global para almacenar el stock actual
        let stockActualProducto = [];

        function cargarStockActual() {
            if (!productoActualId) return;
            
            fetch(`/admin/inventario/producto/${productoActualId}`)
                .then(response => response.json())
                .then(inventarios => {
                    stockActualProducto = inventarios; // Guardar para uso en otras funciones
                    const tbody = document.getElementById('tablaStockActual');
                    
                    if (inventarios.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay stock registrado</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = inventarios.map(inv => `
                        <tr>
                            <td>${inv.nombreUbicacion}</td>
                            <td>${inv.codigoUbicacion}</td>
                            <td><span class="badge bg-primary">${inv.cantidad}</span></td>
                            <td>S/ ${inv.valorUnitario.toFixed(2)}</td>
                            <td><strong>S/ ${inv.valorTotal.toFixed(2)}</strong></td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error al cargar stock:', error);
                    stockActualProducto = [];
                    document.getElementById('tablaStockActual').innerHTML = 
                        '<tr><td colspan="5" class="text-center text-danger">Error al cargar datos</td></tr>';
                });
        }

        function cargarMovimientos() {
            if (!productoActualId) return;
            
            fetch(`/admin/movimientos/producto/${productoActualId}/ultimos`)
                .then(response => response.json())
                .then(movimientos => {
                    const tbody = document.getElementById('tablaMovimientos');
                    
                    if (movimientos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay movimientos registrados</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = movimientos.map(mov => {
                        const fecha = new Date(mov.fechaMovimiento).toLocaleString();
                        const tipoBadge = mov.tipoMovimiento === 'ENTRADA' ? 'bg-success' : 
                                         mov.tipoMovimiento === 'SALIDA' ? 'bg-danger' : 'bg-warning';
                        
                        return `
                            <tr>
                                <td><small>${fecha}</small></td>
                                <td><span class="badge ${tipoBadge}">${mov.tipoMovimiento}</span></td>
                                <td>${mov.cantidad}</td>
                                <td><small>${mov.descripcion || '-'}</small></td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => {
                    console.error('Error al cargar movimientos:', error);
                    document.getElementById('tablaMovimientos').innerHTML = 
                        '<tr><td colspan="4" class="text-center text-danger">Error al cargar datos</td></tr>';
                });
        }

        // Funci√≥n para verificar stock en ubicaci√≥n seleccionada
        function verificarStockEnUbicacion() {
            const ubicacionId = document.getElementById('ubicacionSelect').value;
            
            if (!ubicacionId) {
                ocultarOpcionesStock();
                return;
            }
            
            // Buscar si hay stock en la ubicaci√≥n seleccionada
            const stockEnUbicacion = stockActualProducto.find(inv => inv.idUbicacion == ubicacionId);
            
            if (stockEnUbicacion) {
                mostrarOpcionesActualizacion(stockEnUbicacion);
            } else {
                mostrarOpcionesAsignacion();
            }
        }

        function ocultarOpcionesStock() {
            document.getElementById('stockExistenteInfo').style.display = 'none';
            document.getElementById('tipoOperacionGroup').style.display = 'none';
            document.getElementById('stockResultanteInfo').style.display = 'none';
            
            // Resetear textos a modo asignaci√≥n
            document.getElementById('labelCantidad').textContent = 'Cantidad';
            document.getElementById('helpCantidad').textContent = 'Unidades a ingresar';
            document.getElementById('textoBotonSubmit').textContent = 'Asignar Stock al Inventario';
        }

        function mostrarOpcionesAsignacion() {
            document.getElementById('stockExistenteInfo').style.display = 'none';
            document.getElementById('tipoOperacionGroup').style.display = 'none';
            document.getElementById('stockResultanteInfo').style.display = 'none';
            
            // Textos para nueva asignaci√≥n
            document.getElementById('labelCantidad').textContent = 'Cantidad';
            document.getElementById('helpCantidad').textContent = 'Unidades a ingresar';
            document.getElementById('textoBotonSubmit').textContent = 'Asignar Stock al Inventario';
            
            // Resetear formulario
            document.getElementById('cantidadInput').value = '';
            document.getElementById('valorUnitarioInput').value = '';
            document.getElementById('operacionAgregar').checked = true;
        }

        function mostrarOpcionesActualizacion(stockExistente) {
            // Mostrar informaci√≥n del stock actual
            document.getElementById('stockActualCantidad').textContent = stockExistente.cantidad;
            document.getElementById('stockActualValor').textContent = stockExistente.valorUnitario.toFixed(2);
            document.getElementById('stockActualTotal').textContent = stockExistente.valorTotal.toFixed(2);
            document.getElementById('stockExistenteInfo').style.display = 'block';
            
            // Mostrar opciones de operaci√≥n
            document.getElementById('tipoOperacionGroup').style.display = 'block';
            document.getElementById('stockResultanteInfo').style.display = 'block';
            
            // Cambiar textos
            document.getElementById('labelCantidad').textContent = 'Cantidad';
            document.getElementById('helpCantidad').textContent = 'Unidades para esta operaci√≥n';
            document.getElementById('textoBotonSubmit').textContent = 'Actualizar Stock';
            
            // Prellenar el valor unitario con el valor actual
            document.getElementById('valorUnitarioInput').value = stockExistente.valorUnitario;
            
            // Actualizar c√°lculos
            actualizarCalculosStock();
        }

        function actualizarCalculosStock() {
            const ubicacionId = document.getElementById('ubicacionSelect').value;
            const stockExistente = stockActualProducto.find(inv => inv.idUbicacion == ubicacionId);
            
            if (!stockExistente) {
                actualizarCalculos();
                return;
            }
            
            const cantidad = parseFloat(document.getElementById('cantidadInput').value) || 0;
            const valorUnitario = parseFloat(document.getElementById('valorUnitarioInput').value) || 0;
            const tipoOperacion = document.querySelector('input[name="tipoOperacion"]:checked').value;
            
            let cantidadFinal = stockExistente.cantidad;
            let diferencia = 0;
            
            switch(tipoOperacion) {
                case 'ENTRADA':
                    cantidadFinal = stockExistente.cantidad + cantidad;
                    diferencia = cantidad;
                    document.getElementById('labelCantidad').textContent = 'Cantidad a Agregar';
                    document.getElementById('helpCantidad').textContent = 'Unidades que se agregar√°n al stock';
                    break;
                case 'SALIDA':
                    cantidadFinal = Math.max(0, stockExistente.cantidad - cantidad);
                    diferencia = -cantidad;
                    document.getElementById('labelCantidad').textContent = 'Cantidad a Reducir';
                    document.getElementById('helpCantidad').textContent = 'Unidades que se quitar√°n del stock';
                    break;
                case 'AJUSTE':
                    cantidadFinal = cantidad;
                    diferencia = cantidad - stockExistente.cantidad;
                    document.getElementById('labelCantidad').textContent = 'Cantidad Final';
                    document.getElementById('helpCantidad').textContent = 'Cantidad total que debe quedar en stock';
                    break;
            }
            
            // Actualizar informaci√≥n de stock resultante
            document.getElementById('stockFinalCantidad').textContent = cantidadFinal;
            document.getElementById('diferenciaCantidad').textContent = diferencia > 0 ? `+${diferencia}` : diferencia;
            document.getElementById('stockFinalTotal').textContent = (cantidadFinal * valorUnitario).toFixed(2);
            
            // Colorear la diferencia
            const elemDiferencia = document.getElementById('diferenciaCantidad');
            if (diferencia > 0) {
                elemDiferencia.className = 'text-success fw-bold';
            } else if (diferencia < 0) {
                elemDiferencia.className = 'text-danger fw-bold';
            } else {
                elemDiferencia.className = 'text-muted';
            }
            
            // Actualizar c√°lculos normales
            actualizarCalculos();
        }

        // Event listeners para c√°lculos autom√°ticos
        document.getElementById('cantidadInput').addEventListener('input', actualizarCalculosStock);
        document.getElementById('valorUnitarioInput').addEventListener('input', actualizarCalculosStock);
        document.getElementById('ubicacionSelect').addEventListener('change', verificarStockEnUbicacion);
        
        // Event listeners para cambios en tipo de operaci√≥n
        document.querySelectorAll('input[name="tipoOperacion"]').forEach(radio => {
            radio.addEventListener('change', actualizarCalculosStock);
        });

        // Event listeners para las pesta√±as
        document.getElementById('actual-tab').addEventListener('click', cargarStockActual);
        document.getElementById('movimientos-tab').addEventListener('click', cargarMovimientos);

        // Form submit para asignar stock
        document.getElementById('formAsignarStock').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ubicacionId = document.getElementById('ubicacionSelect').value;
            const stockExistente = stockActualProducto.find(inv => inv.idUbicacion == ubicacionId);
            
            const datos = {
                idProducto: productoActualId,
                idUbicacion: ubicacionId,
                cantidad: parseInt(document.getElementById('cantidadInput').value),
                valorUnitario: parseFloat(document.getElementById('valorUnitarioInput').value),
                descripcion: document.getElementById('descripcionInput').value
            };

            // Si hay stock existente, agregar tipo de operaci√≥n
            if (stockExistente) {
                datos.tipoOperacion = document.querySelector('input[name="tipoOperacion"]:checked').value;
            }

            // Validaciones
            if (!datos.idUbicacion) {
                Swal.fire('Error', 'Debe seleccionar una ubicaci√≥n', 'error');
                return;
            }

            // Validaci√≥n especial para salidas
            if (stockExistente && datos.tipoOperacion === 'SALIDA' && datos.cantidad > stockExistente.cantidad) {
                Swal.fire('Error', `No puedes reducir m√°s stock del disponible. Stock actual: ${stockExistente.cantidad}`, 'error');
                return;
            }

            // Mostrar confirmaci√≥n contextual
            const tituloConfirmacion = stockExistente ? 
                '¬øConfirmar actualizaci√≥n de stock?' : 
                '¬øConfirmar asignaci√≥n de stock?';
            const textoConfirmacion = stockExistente ? 
                `Se ${datos.tipoOperacion === 'ENTRADA' ? 'agregar√°' : 
                     datos.tipoOperacion === 'SALIDA' ? 'reducir√°' : 'ajustar√°'} el stock en esta ubicaci√≥n` :
                'Se asignar√° stock nuevo en esta ubicaci√≥n';

            Swal.fire({
                title: tituloConfirmacion,
                text: textoConfirmacion,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, continuar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Determinar endpoint seg√∫n si es nuevo o actualizaci√≥n
                    const endpoint = stockExistente ? 
                        '/admin/inventario/actualizar-stock' : 
                        '/admin/inventario/asignar-stock';

                    fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            [header]: token
                        },
                        body: JSON.stringify(datos)
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            return response.text().then(text => Promise.reject(text));
                        }
                    })
                    .then(result => {
                        const mensaje = stockExistente ? 'Stock actualizado correctamente' : 'Stock asignado correctamente';
                        
                        Swal.fire({
                            title: '¬°√âxito!',
                            text: mensaje,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                        
                        // Limpiar formulario y ocultar opciones
                        document.getElementById('formAsignarStock').reset();
                        ocultarOpcionesStock();
                        
                        // Recargar stock actual
                        cargarStockActual();
                        
                        // Recargar stock actual si est√° visible en la pesta√±a
                        if (document.getElementById('actual-tab').classList.contains('active')) {
                            setTimeout(cargarStockActual, 500); // Peque√±o delay para asegurar que se actualiz√≥
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        const mensajeError = stockExistente ? 'No se pudo actualizar el stock' : 'No se pudo asignar el stock';
                        Swal.fire('Error', error || mensajeError, 'error');
                    });
                }
            });
        });
    </script>
</body>

</html>